# -*- coding: utf-8 -*-
"""admin

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1S9lELbDuvcsZLsJ_P91yXmGgGXQLJ8-l
"""
import streamlit as st
import gspread
from google.oauth2.service_account import Credentials
from datetime import datetime

# --- Config ---
SPREADSHEET_ID = "1leh-sPgpoHy3E62l_Rnc11JFyyF-kBNlWTICxW1tam8"  # Your Google Sheet ID
ADMIN_CODE = st.secrets.get("admin_code", "12345")  # Set your admin code in Streamlit secrets

# --- Google Sheets setup ---
def get_sheet():
    scopes = ["https://www.googleapis.com/auth/spreadsheets"]
    creds = Credentials.from_service_account_info(
        st.secrets["google_service_account"],
        scopes=scopes
    )
    client = gspread.authorize(creds)
    sheet = client.open_by_key(SPREADSHEET_ID).sheet1
    return sheet

# --- Main ---
def main():
    st.title("ðŸš° Water Leakage Reporting - Admin Panel")

    admin_input = st.text_input("Enter Admin Code:", type="password")
    if admin_input != ADMIN_CODE:
        st.warning("Please enter a valid admin code to access the reports.")
        return

    sheet = get_sheet()
    data = sheet.get_all_records()

    if not data:
        st.info("No reports found.")
        return

    st.success(f"Loaded {len(data)} reports.")

    # Display reports with status update option
    for idx, report in enumerate(data, start=2):  # start=2 because sheet rows start at 1 with header
        st.markdown(f"### Report #{idx-1}")
        st.write(report)
        
        current_status = report.get("Status", "Pending")
        status = st.selectbox(
            f"Update status for Report #{idx-1}", 
            options=["Pending", "In Progress", "Resolved", "Rejected"], 
            index=["Pending", "In Progress", "Resolved", "Rejected"].index(current_status),
            key=f"status_{idx}"
        )
        
        if st.button(f"Update Status for Report #{idx-1}", key=f"update_{idx}"):
            sheet.update_cell(idx, 7, status)  # Assuming column 7 = 'Status'
            sheet.update_cell(idx, 8, datetime.now().strftime("%Y-%m-%d %H:%M:%S"))  # Optional: update status timestamp column 8
            st.success(f"Status for Report #{idx-1} updated to '{status}'.")

if __name__ == "__main__":
    main()
